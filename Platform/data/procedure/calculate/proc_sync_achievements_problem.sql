-- ============================================================
-- <T>员工无业绩</T>
-- <author>赵高发</author>
-- <time>2015/12/05</time>
-- ============================================================
DELIMITER $$

USE `EAI_CALCULATE`$$

DROP PROCEDURE IF EXISTS `Proc_Sync_Achievements_Problem` $$

CREATE PROCEDURE `Proc_Sync_Achievements_Problem` () 
BEGIN
   -- 更新
   UPDATE 
      EAI_CALCULATE.CL_COK_ACHIEVEMENTS_PROBLEM t2,
      (SELECT 
         t1.DEPARTMENT_LEVEL2_ID,
         t1.DEPARTMENT_LEVEL2_LINK_ID,
         t1.DEPARTMENT_LEVEL2_LABEL,
         t1.MARKTERS_NUM_PER_DEPARTMENT,
         t1.MARKETERS_NUM_OF_ZEROWORK,
         t1.MARKETERS_NUM_OF_ZEROWORK_OVERYEAR,
         t1.MARKETERS_NUM_OF_ZEROWORK / MARKTERS_NUM_PER_DEPARTMENT AS RATE 
      FROM
         (SELECT 
            m.DEPARTMENT_LEVEL2_ID,
            m.DEPARTMENT_LEVEL2_LINK_ID,
            m.DEPARTMENT_LEVEL2_LABEL,
            COUNT(m.GUID) AS MARKTERS_NUM_PER_DEPARTMENT,
            a.MARKETERS_NUM_OF_ZEROWORK,
            b.MARKETERS_NUM_OF_ZEROWORK_OVERYEAR 
         FROM
            EAI_STATISTICS.ST_FIN_MARKETER m,
            (SELECT 
               COUNT(g.GUID) AS MARKETERS_NUM_OF_ZEROWORK,
               g.DEPARTMENT_LEVEL2_LINK_ID 
            FROM
               EAI_STATISTICS.ST_FIN_MARKETER g 
            WHERE g.STATUS_CD = 1 
               AND NOT EXISTS 
               (SELECT 
                  d.MARKETER_LINK_ID 
               FROM
                  EAI_STATISTICS.ST_FIN_DYNAMIC d 
               WHERE g.`LINK_ID` = d.`CUSTOMER_LINK_ID`) 
            GROUP BY g.DEPARTMENT_LEVEL2_LINK_ID) a,
            (SELECT 
               COUNT(q.GUID) AS MARKETERS_NUM_OF_ZEROWORK_OVERYEAR,
               q.DEPARTMENT_LEVEL2_LINK_ID 
            FROM
               EAI_STATISTICS.ST_FIN_MARKETER q 
            WHERE q.STATUS_CD = 1 
               AND NOT EXISTS 
               (SELECT 
                  d.MARKETER_LINK_ID 
               FROM
                  EAI_STATISTICS.ST_FIN_DYNAMIC d 
               WHERE q.`LINK_ID` = d.`CUSTOMER_LINK_ID`) 
               AND TIMESTAMPDIFF(MONTH, q.`ENTER_DATE`, DATE(NOW())) >= 12 
            GROUP BY DEPARTMENT_LEVEL2_LINK_ID) b 
         WHERE m.STATUS_CD = 1 
            AND m.`DEPARTMENT_LEVEL2_LINK_ID` = a.DEPARTMENT_LEVEL2_LINK_ID 
            AND m.DEPARTMENT_LEVEL2_LINK_ID = b.DEPARTMENT_LEVEL2_LINK_ID 
         GROUP BY m.DEPARTMENT_LEVEL2_LINK_ID) t1) t 
   SET
      t2.DEPARTMENT_ID = t.DEPARTMENT_LEVEL2_ID,
      t2.DEPARTMENT_LABEL = t.DEPARTMENT_LEVEL2_LABEL,
      t2.MARKETER_TOTAL = t.MARKTERS_NUM_PER_DEPARTMENT,
      t2.NO_ACHIEVEMENTS_MARKETER = t.MARKETERS_NUM_OF_ZEROWORK_OVERYEAR,
      t2.NUMBER_OF_PEOPLE_RATE = t.RATE,
      t2.NO_ACHIEVEMENTS_YEAR = t.MARKETERS_NUM_OF_ZEROWORK_OVERYEAR,
      t2.UPDATE_DATE = NOW() 
   WHERE t2.DEPARTMENT_LID = t.DEPARTMENT_LEVEL2_LINK_ID ;
   
   -- 插入
   INSERT INTO EAI_CALCULATE.CL_COK_ACHIEVEMENTS_PROBLEM (
      GUID,
      DEPARTMENT_ID,
      DEPARTMENT_LID,
      DEPARTMENT_LABEL,
      MARKETER_TOTAL,
      NO_ACHIEVEMENTS_MARKETER,
      NO_ACHIEVEMENTS_YEAR,
      NUMBER_OF_PEOPLE_RATE,
      CREATE_DATE
   ) 
   SELECT 
      REPLACE(UPPER(UUID()), '-', '') UUI,
      s1.DEPARTMENT_LEVEL2_ID,
      s1.DEPARTMENT_LEVEL2_LINK_ID,
      s1.DEPARTMENT_LEVEL2_LABEL,
      s1.MARKTERS_NUM_PER_DEPARTMENT,
      s1.MARKETERS_NUM_OF_ZEROWORK,
      s1.MARKETERS_NUM_OF_ZEROWORK_OVERYEAR,
      s1.MARKETERS_NUM_OF_ZEROWORK / MARKTERS_NUM_PER_DEPARTMENT AS RATE,
      NOW() DT 
   FROM
      (SELECT 
         m.DEPARTMENT_LEVEL2_ID,
         m.DEPARTMENT_LEVEL2_LINK_ID,
         m.DEPARTMENT_LEVEL2_LABEL,
         COUNT(m.GUID) AS MARKTERS_NUM_PER_DEPARTMENT,
         a.MARKETERS_NUM_OF_ZEROWORK,
         b.MARKETERS_NUM_OF_ZEROWORK_OVERYEAR 
      FROM
         EAI_STATISTICS.ST_FIN_MARKETER m,
         (SELECT 
            COUNT(w.GUID) AS MARKETERS_NUM_OF_ZEROWORK,
            w.DEPARTMENT_LEVEL2_LINK_ID 
         FROM
            EAI_STATISTICS.ST_FIN_MARKETER w 
         WHERE w.STATUS_CD = 1 
            AND NOT EXISTS 
            (SELECT 
               d.MARKETER_LINK_ID 
            FROM
               EAI_STATISTICS.ST_FIN_DYNAMIC d 
            WHERE w.`LINK_ID` = d.`CUSTOMER_LINK_ID`) 
         GROUP BY DEPARTMENT_LEVEL2_LINK_ID) a,
         (SELECT 
            COUNT(p.GUID) AS MARKETERS_NUM_OF_ZEROWORK_OVERYEAR,
            p.DEPARTMENT_LEVEL2_LINK_ID 
         FROM
            EAI_STATISTICS.ST_FIN_MARKETER p 
         WHERE p.STATUS_CD = 1 
            AND NOT EXISTS 
            (SELECT 
               d.MARKETER_LINK_ID 
            FROM
               EAI_STATISTICS.ST_FIN_DYNAMIC d 
            WHERE p.`LINK_ID` = d.`CUSTOMER_LINK_ID`) 
            AND TIMESTAMPDIFF(MONTH, p.`ENTER_DATE`, DATE(NOW())) >= 12 
         GROUP BY DEPARTMENT_LEVEL2_LINK_ID) b 
      WHERE m.STATUS_CD = 1 
         AND m.`DEPARTMENT_LEVEL2_LINK_ID` = a.DEPARTMENT_LEVEL2_LINK_ID 
         AND m.DEPARTMENT_LEVEL2_LINK_ID = b.DEPARTMENT_LEVEL2_LINK_ID 
      GROUP BY m.DEPARTMENT_LEVEL2_LINK_ID) s1 
   WHERE NOT EXISTS 
      (SELECT 
         s2.DEPARTMENT_ID 
      FROM
         EAI_CALCULATE.CL_COK_ACHIEVEMENTS_PROBLEM s2 
      WHERE s1.DEPARTMENT_LEVEL2_ID = s2.DEPARTMENT_ID) ;
END $$

DELIMITER ;