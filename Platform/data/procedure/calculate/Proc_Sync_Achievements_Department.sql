-- ============================================================
-- <T>各公司业绩统计</T>
-- <author>赵高发</author>
-- <time>2015/12/01</time>
-- ============================================================
DELIMITER $$

USE `EAI_CALCULATE`$$

DROP PROCEDURE IF EXISTS `Proc_Sync_Achievements_Department`$$

CREATE PROCEDURE `Proc_Sync_Achievements_Department` () 
BEGIN
   -- 更新公司的DEPARTMENT_LEVEL2_LINK_ID的记录
   UPDATE 
      `EAI_CALCULATE`.CL_COK_ACHIEVEMENTS_DEPARTMENT a,
      (SELECT 
         c.DEPARTMENT_LEVEL2_LINK_ID,
         c.DEPARTMENT_LEVEL2_LABEL,
         SUM(DEPARTMENT_INVESTMENT) TOTAL,
         NOW() 
      FROM
         `EAI_STATISTICS`.`ST_FIN_DEPARTMENT_PHASE` c 
      WHERE MONTH(RECORD_MONTH) = MONTH(NOW()) 
         AND DEPARTMENT_LEVEL2_LINK_ID IS NOT NULL 
      GROUP BY DEPARTMENT_LEVEL2_LINK_ID) b 
   SET
      a.DEPARTMENT_LABEL = b.DEPARTMENT_LEVEL2_LABEL,
      a.PERFORMANCE_TOTAL = b.TOTAL,
      a.UPDATE_DATE = NOW() 
   WHERE a.DEPARTMENT_LID = b.DEPARTMENT_LEVEL2_LINK_ID ;
   -- 向表CL_COK_ACHIEVEMENTS_DEPARTMENT中插入DEPARTMENT_LEVEL2_LINK_ID没有的记录
   INSERT INTO `EAI_CALCULATE`.CL_COK_ACHIEVEMENTS_DEPARTMENT (
      GUID,
      DEPARTMENT_ID,
      DEPARTMENT_LID,
      DEPARTMENT_LABEL,
      PERFORMANCE_TOTAL,
      CREATE_DATE
   ) 
   SELECT 
      UID,
      DEPARTMENT_LEVEL2_ID,
      DEPARTMENT_LEVEL2_LINK_ID,
      DEPARTMENT_LEVEL2_LABEL,
      TOTAL,
      NW 
   FROM
      (SELECT 
         REPLACE(UPPER(UUID()), '-', '') UID,
         p.DEPARTMENT_LEVEL2_ID,
         p.DEPARTMENT_LEVEL2_LINK_ID,
         p.DEPARTMENT_LEVEL2_LABEL,
         SUM(DEPARTMENT_INVESTMENT) TOTAL,
         NOW() NW 
      FROM
         `EAI_STATISTICS`.`ST_FIN_DEPARTMENT_PHASE` p 
      WHERE MONTH(RECORD_MONTH) = MONTH(NOW()) 
         AND DEPARTMENT_LEVEL2_LINK_ID IS NOT NULL 
      GROUP BY DEPARTMENT_LEVEL2_LINK_ID) t 
   WHERE NOT EXISTS 
      (SELECT 
         t2.DEPARTMENT_LID 
      FROM
         `EAI_CALCULATE`.CL_COK_ACHIEVEMENTS_DEPARTMENT t2 
      WHERE t2.DEPARTMENT_LID = t.DEPARTMENT_LEVEL2_LINK_ID) ;
END $$

DELIMITER ;